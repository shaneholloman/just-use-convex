---
title: Agent Configuration
description: Configure the AI agent with environment variables, models, and deployment settings
---

# Agent Configuration

Configure the agent system through environment variables, Cloudflare Workers settings, and Alchemy deployment configuration.

## Environment Variables

### Required Variables

```bash
# OpenRouter API (required for LLM access)
OPENROUTER_API_KEY=sk-or-v1-xxxx

# Default model when none selected
OPENROUTER_MODEL=openai/gpt-4o

# Convex backend URL
CONVEX_URL=https://your-deployment.convex.cloud

# Frontend URL for CORS
SITE_URL=https://your-app.com

# Agent URL (set in frontend .env)
VITE_AGENT_URL=https://your-agent.workers.dev
```

### Setting Variables

For local development with Alchemy:

```bash
# packages/agent/.dev.vars
OPENROUTER_API_KEY=sk-or-v1-xxxx
OPENROUTER_MODEL=openai/gpt-4o
CONVEX_URL=https://your-deployment.convex.cloud
SITE_URL=http://localhost:5173
```

For production, set secrets via Cloudflare dashboard or CLI:

```bash
npx wrangler secret put OPENROUTER_API_KEY
npx wrangler secret put CONVEX_URL
```

## Alchemy Configuration

The agent deployment is configured in `alchemy.run.ts`:

```ts
// packages/agent/alchemy.run.ts
import alchemy from "alchemy";
import { Worker, DurableObjectNamespace } from "alchemy/cloudflare";

const worker = await Worker("agent-worker", {
  name: "agent-worker",
  entrypoint: "./src/index.ts",
  bindings: {
    CONVEX_URL: alchemy.var("CONVEX_URL"),
    OPENROUTER_API_KEY: alchemy.secret("OPENROUTER_API_KEY"),
    OPENROUTER_MODEL: alchemy.var("OPENROUTER_MODEL"),
    SITE_URL: alchemy.var("SITE_URL"),
  },
  durableObjects: {
    AgentWorker: DurableObjectNamespace("AgentWorker", {
      className: "AgentWorker",
      sqlite: true, // Enable SQLite for checkpointing
    }),
  },
  observability: {
    enabled: true,
    logs: true,
  },
});

export { worker };
```

## Wrangler Configuration

```json
// packages/agent/wrangler.json
{
  "name": "agent-worker",
  "main": "src/index.ts",
  "compatibility_date": "2024-12-01",
  "durable_objects": {
    "bindings": [
      {
        "name": "AgentWorker",
        "class_name": "AgentWorker"
      }
    ]
  },
  "migrations": [
    {
      "tag": "v1",
      "new_sqlite_classes": ["AgentWorker"]
    }
  ]
}
```

## Model Configuration

### Supported Models

Models are fetched from OpenRouter and filtered by the frontend:

```ts
// src/hooks/use-openrouter-models.ts
const HIDDEN_AUTHORS = ["liquid", "sao10k"];
const MIN_MODEL_AGE_DAYS = 365;

export function useOpenRouterModels() {
  return useQuery({
    queryKey: ["openrouter-models"],
    queryFn: async () => {
      const response = await fetch("/api/models");
      const { data } = await response.json();

      return data
        .filter((m) => !m.pricing.completion === "0") // Filter free models
        .filter((m) => !HIDDEN_AUTHORS.includes(m.id.split("/")[0]))
        .filter((m) => isRecentModel(m.created));
    },
  });
}
```

### Reasoning Models

Enable extended thinking for supported models:

```ts
// In AgentWorker
const model = new ChatOpenAI({
  model: modelId,
  reasoning: reasoningEffort
    ? { effort: reasoningEffort }
    : undefined,
  modelKwargs: {
    reasoning_effort: reasoningEffort,
  },
});
```

Supported reasoning models include:
- `openai/o1`
- `openai/o1-mini`
- `openai/o3-mini`
- `anthropic/claude-3.5-sonnet` (with thinking)
- `deepseek/deepseek-r1`

## System Prompt

Customize the agent's behavior by modifying the system prompt:

```ts
// packages/agent/src/index.ts
const agent = createDeepAgent({
  model,
  systemPrompt: "You are a helpful assistant.", // Customize this
  checkpointer,
});
```

### Example System Prompts

```ts
// Task-focused assistant
const systemPrompt = `You are a task management assistant.
Help users organize their work and prioritize tasks.
When given a list of items, structure them by priority and due date.`;

// Code assistant
const systemPrompt = `You are an expert software developer.
Provide clear, well-documented code examples.
Always explain your reasoning and suggest best practices.`;

// Customer support
const systemPrompt = `You are a friendly customer support agent.
Help users with their questions about our product.
Be concise but thorough in your responses.`;
```

## CORS Configuration

Configure allowed origins for WebSocket connections:

```ts
// packages/agent/src/index.ts
export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    return await routeAgentRequest(request, env, {
      prefix: "agents",
      cors: {
        "Access-Control-Allow-Origin": env.SITE_URL,
        "Access-Control-Allow-Credentials": "true",
        "Access-Control-Allow-Methods": "GET, POST, HEAD, OPTIONS",
        "Access-Control-Allow-Headers":
          "Content-Type, Authorization, Cookie, Upgrade, Connection, " +
          "Sec-WebSocket-Key, Sec-WebSocket-Version, Sec-WebSocket-Extensions",
        "Access-Control-Max-Age": "86400",
      },
    });
  },
};
```

## Deployment

### Development

```bash
cd packages/agent
bun run dev
```

### Production

```bash
cd packages/agent
bun run deploy
```

### Checking Logs

```bash
npx wrangler tail agent-worker
```

## Customizing the Checkpointer

The checkpointer can be configured for different retention policies:

```ts
// packages/agent/src/checkpointer.ts
export class CloudflareDOCheckpointer extends BaseCheckpointSaver {
  private setup(): void {
    this.sql.exec(`
      CREATE TABLE IF NOT EXISTS checkpoints (
        thread_id TEXT NOT NULL,
        checkpoint_ns TEXT NOT NULL DEFAULT '',
        checkpoint_id TEXT NOT NULL,
        parent_checkpoint_id TEXT,
        type TEXT,
        checkpoint BLOB,
        metadata BLOB,
        PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id)
      );
    `);
  }

  // Add custom cleanup methods
  async deleteThread(threadId: string): Promise<void> {
    this.sql.exec(
      `DELETE FROM checkpoints WHERE thread_id = ?`,
      threadId
    );
  }
}
```

## Adding Custom Tools

Extend the agent with custom tools using LangChain:

```ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";

const weatherTool = tool(
  async ({ location }) => {
    const response = await fetch(`https://api.weather.com/${location}`);
    return response.json();
  },
  {
    name: "get_weather",
    description: "Get current weather for a location",
    schema: z.object({
      location: z.string().describe("City name"),
    }),
  }
);

// Add to agent
const agent = createDeepAgent({
  model,
  systemPrompt: "You can check the weather.",
  checkpointer,
  tools: [weatherTool],
});
```
